<!doctype html><html lang=en-us><head><title>在Docker中搭建JupyterHub服务器 // 无名空间</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.111.2"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="oaheix"><meta name=description content><link rel=stylesheet href=/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css><meta name=twitter:card content="summary"><meta name=twitter:title content="在Docker中搭建JupyterHub服务器"><meta name=twitter:description content="功能需求 因团队项目需要，需组建供多人同时使用的深度学习服务器一台，计划支持以下功能：
支持通过浏览器访问服务器 支持多用户同时访问，且互不干扰 支持在用户间通过共享目录合作开发 支持用户使用服务器上的独立显卡 核心思想 在Docker中开启JupyterHub服务器 由于在本机配置环境时对环境破坏较大，且不易维护，故可采用在Docker镜像中部署 传统的Jupyter Notebook乃至JupyterLab仅支持单用户访问，不满足需求，故采用支持多人访问的JupyterHub作为服务器 在服务器中为每个用户开启一个JupyterLab容器 在JupyterHub平台上为每个用户单独开启一个Docker容器 在新开启的容器中开启一个JupyterLab服务，以支持单人操作 所需软件 理论上可在任何支持Docker的软件平台上部署，本文在Manjaro Linux操作系统上部署，可通过yay安装：
git：用于版本控制 docker与docker-compose：用于承载平台服务 nvidia与nvidia-container-toolkit：用于驱动显卡并被Docker容器识别 主要步骤 克隆仓库 jupyterhub-deploy-docker至本地 git clone https://github.com/jupyterhub/jupyterhub-deploy-docker.git 自定义少量配置 修改每个用户启动jupyter notebook所用镜像为cschranz/gpu-jupyter以支持nvidia显卡 在docker-compose.yaml文件中，services的environment下将DOCKER_NOTEBOOK_IMAGE的值修改为cschranz/gpu-jupyter:latest： # JupyterHub will spawn this Notebook image for users DOCKER_NOTEBOOK_IMAGE: cschranz/gpu-jupyter:latest 设置多用户均可访问的共享文件夹/home/jovyan/shared，可在其内实现多人合作开发 在jupyterhub_config.py文件中，修改变量c.DockerSpawner.volumns的值： # Mount the real user's Docker volume on the host to the notebook user's # notebook directory in the container c.DockerSpawner.volumes = { 'jupyterhub-user-{username}': notebook_dir, 'jupyterhub-shared': { 'bind': '/home/jovyan/shared', 'mode': 'rw' } } 令单用户容器可访问主机显卡 在jupyterhub_config."><meta property="og:title" content="在Docker中搭建JupyterHub服务器"><meta property="og:description" content="功能需求 因团队项目需要，需组建供多人同时使用的深度学习服务器一台，计划支持以下功能：
支持通过浏览器访问服务器 支持多用户同时访问，且互不干扰 支持在用户间通过共享目录合作开发 支持用户使用服务器上的独立显卡 核心思想 在Docker中开启JupyterHub服务器 由于在本机配置环境时对环境破坏较大，且不易维护，故可采用在Docker镜像中部署 传统的Jupyter Notebook乃至JupyterLab仅支持单用户访问，不满足需求，故采用支持多人访问的JupyterHub作为服务器 在服务器中为每个用户开启一个JupyterLab容器 在JupyterHub平台上为每个用户单独开启一个Docker容器 在新开启的容器中开启一个JupyterLab服务，以支持单人操作 所需软件 理论上可在任何支持Docker的软件平台上部署，本文在Manjaro Linux操作系统上部署，可通过yay安装：
git：用于版本控制 docker与docker-compose：用于承载平台服务 nvidia与nvidia-container-toolkit：用于驱动显卡并被Docker容器识别 主要步骤 克隆仓库 jupyterhub-deploy-docker至本地 git clone https://github.com/jupyterhub/jupyterhub-deploy-docker.git 自定义少量配置 修改每个用户启动jupyter notebook所用镜像为cschranz/gpu-jupyter以支持nvidia显卡 在docker-compose.yaml文件中，services的environment下将DOCKER_NOTEBOOK_IMAGE的值修改为cschranz/gpu-jupyter:latest： # JupyterHub will spawn this Notebook image for users DOCKER_NOTEBOOK_IMAGE: cschranz/gpu-jupyter:latest 设置多用户均可访问的共享文件夹/home/jovyan/shared，可在其内实现多人合作开发 在jupyterhub_config.py文件中，修改变量c.DockerSpawner.volumns的值： # Mount the real user's Docker volume on the host to the notebook user's # notebook directory in the container c.DockerSpawner.volumes = { 'jupyterhub-user-{username}': notebook_dir, 'jupyterhub-shared': { 'bind': '/home/jovyan/shared', 'mode': 'rw' } } 令单用户容器可访问主机显卡 在jupyterhub_config."><meta property="og:type" content="article"><meta property="og:url" content="http://xiehao.github.io/blogs/2023-01-19-docker-jupyterhub/"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2023-01-19T14:57:00+08:00"><meta property="article:modified_time" content="2023-01-19T14:57:00+08:00"></head><body><header class=app-header><a href=http://xiehao.github.io/><img class=app-header-avatar src=/xie.png alt=oaheix></a>
<span class=app-header-title>无名空间</span><nav class=app-header-menu><a class=app-header-menu-item href=/>主页</a>
-
<a class=app-header-menu-item href=/tags/>标签</a>
-
<a class=app-header-menu-item href=/about/>关于</a></nav><p>一名淡定男教师的点滴分享</p><div class=app-header-social><a href=https://github.com/xiehao target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=mailto:oaheix@gmail.com target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-mail"><title>邮箱</title><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>在Docker中搭建JupyterHub服务器</h1><div class=post-meta><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 19, 2023</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>1 min read</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=http://xiehao.github.io/tags/docker/>docker</a>
<a class=tag href=http://xiehao.github.io/tags/jupyterhub/>jupyterhub</a>
<a class=tag href=http://xiehao.github.io/tags/%E6%95%99%E7%A8%8B/>教程</a></div></div></header><div class=post-content><h3 id=功能需求>功能需求</h3><p>因团队项目需要，需组建供多人同时使用的深度学习服务器一台，计划支持以下功能：</p><ul><li>支持通过浏览器访问服务器</li><li>支持多用户同时访问，且互不干扰</li><li>支持在用户间通过共享目录合作开发</li><li>支持用户使用服务器上的独立显卡</li></ul><h3 id=核心思想>核心思想</h3><h4 id=在docker中开启jupyterhub服务器>在<code>Docker</code>中开启<code>JupyterHub</code>服务器</h4><ul><li>由于在本机配置环境时对环境破坏较大，且不易维护，故可采用在<code>Docker</code>镜像中部署</li><li>传统的<code>Jupyter Notebook</code>乃至<code>JupyterLab</code>仅支持单用户访问，不满足需求，故采用支持多人访问的<code>JupyterHub</code>作为服务器</li></ul><h4 id=在服务器中为每个用户开启一个jupyterlab容器>在服务器中为<strong>每个</strong>用户开启一个<code>JupyterLab</code>容器</h4><ul><li>在<code>JupyterHub</code>平台上为每个用户单独开启一个<code>Docker</code>容器</li><li>在新开启的容器中开启一个<code>JupyterLab</code>服务，以支持单人操作</li></ul><h3 id=所需软件>所需软件</h3><p>理论上可在任何支持<code>Docker</code>的软件平台上部署，本文在Manjaro Linux操作系统上部署，可通过<code>yay</code>安装：</p><ul><li><code>git</code>：用于版本控制</li><li><code>docker</code>与<code>docker-compose</code>：用于承载平台服务</li><li><code>nvidia</code>与<code>nvidia-container-toolkit</code>：用于驱动显卡并被<code>Docker</code>容器识别</li></ul><h3 id=主要步骤>主要步骤</h3><h4 id=克隆仓库-jupyterhub-deploy-dockerhttpsgithubcomjupyterhubjupyterhub-deploy-docker至本地>克隆仓库 <a href=https://github.com/jupyterhub/jupyterhub-deploy-docker>jupyterhub-deploy-docker</a>至本地</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/jupyterhub/jupyterhub-deploy-docker.git
</span></span></code></pre></div><h4 id=自定义少量配置>自定义少量配置</h4><ul><li>修改每个用户启动<code>jupyter notebook</code>所用镜像为<a href=https://hub.docker.com/r/cschranz/gpu-jupyter>cschranz/gpu-jupyter</a>以支持<code>nvidia</code>显卡<ul><li>在<code>docker-compose.yaml</code>文件中，<code>services</code>的<code>environment</code>下将<code>DOCKER_NOTEBOOK_IMAGE</code>的值修改为<code>cschranz/gpu-jupyter:latest</code>：<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># JupyterHub will spawn this Notebook image for users</span>
</span></span><span style=display:flex><span>DOCKER_NOTEBOOK_IMAGE: cschranz<span style=color:#f92672>/</span>gpu<span style=color:#f92672>-</span>jupyter:latest
</span></span></code></pre></div></li></ul></li><li>设置多用户均可访问的共享文件夹<code>/home/jovyan/shared</code>，可在其内实现多人合作开发<ul><li>在<code>jupyterhub_config.py</code>文件中，修改变量<code>c.DockerSpawner.volumns</code>的值：<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Mount the real user&#39;s Docker volume on the host to the notebook user&#39;s</span>
</span></span><span style=display:flex><span><span style=color:#75715e># notebook directory in the container</span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>DockerSpawner<span style=color:#f92672>.</span>volumes <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;jupyterhub-user-</span><span style=color:#e6db74>{username}</span><span style=color:#e6db74>&#39;</span>: notebook_dir,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;jupyterhub-shared&#39;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;bind&#39;</span>: <span style=color:#e6db74>&#39;/home/jovyan/shared&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;mode&#39;</span>: <span style=color:#e6db74>&#39;rw&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li><li>令单用户容器可访问主机显卡<ul><li>在<code>jupyterhub_config.py</code>文件中，新增若干行以设置变量<code>c.DockerSpawner.extra_host_config</code>的值：<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> docker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c<span style=color:#f92672>.</span>DockerSpawner<span style=color:#f92672>.</span>extra_host_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;device_requests&#34;</span>: [
</span></span><span style=display:flex><span>        docker<span style=color:#f92672>.</span>types<span style=color:#f92672>.</span>DeviceRequest(
</span></span><span style=display:flex><span>            count<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            capabilities<span style=color:#f92672>=</span>[[<span style=color:#e6db74>&#34;gpu&#34;</span>]],
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li></ul><h4 id=开启关闭jupyterhub服务>开启、关闭<code>jupyterhub</code>服务</h4><ul><li><p>拉取创建用户<code>jupyterlab</code>所需镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker pull cschranz/gpu-jupyter
</span></span></code></pre></div></li><li><p>开启<code>jupyterhub</code>服务器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose up -d
</span></span></code></pre></div></li><li><p>关闭<code>jupyterhub</code>服务器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose down
</span></span></code></pre></div></li></ul><h4 id=后续设置>后续设置</h4><ul><li>在开启服务后，为主机的共享目录加入其他用户的写入权限（默认无法写入）<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  sudo chmod -R o+rw /path/to/docker/volumns/jupyterhub-shared
</span></span></code></pre></div></li></ul><h4 id=用户使用>用户使用</h4><ul><li>若服务器的IP地址为<code>x.x.x.x</code>，则可访问<a href=http://0.0.0.0:8000>http://x.x.x.x:8000</a></li><li>首次使用须注册账号，后可凭此账号登录并使用</li></ul><h3 id=其他问题>其他问题</h3><h4 id=cschranzgpu-jupyter镜像占用空间过多><code>cschranz/gpu-jupyter</code>镜像占用空间过多</h4><ul><li>目前占用20G以上，考虑在此基础上进行精简自定义</li></ul><h4 id=不支持广域网访问>不支持广域网访问</h4><ul><li>可能需要内网穿透等技术，暂时不折腾</li></ul><h4 id=用户权限管理过于简单>用户权限管理过于简单</h4><ul><li>后续有待加强</li></ul><h3 id=参考资料>参考资料</h3><ul><li><a href=https://www.baeldung.com/ops/docker-compose>Introduction to Docker Compose | Baeldung</a></li><li><a href=https://github.com/jupyterhub/dockerspawner/issues/244#issuecomment-785866378>https://github.com/jupyterhub/dockerspawner/issues/244#issuecomment-785866378</a></li><li><a href=https://jupyterhub-dockerspawner.readthedocs.io/en/latest/api/index.html>DockerSpawner API</a></li><li><a href=https://www.biaodianfu.com/docker-jupyterhub.html#Docker%E5%AE%B9%E5%99%A8%E5%86%85%E5%A4%9A%E7%94%A8%E6%88%B7%E7%89%88JupyterHub%E6%94%AF%E6%8C%81GPU>Docker安装多用户版JupyterHub – 标点符</a></li><li><a href=https://tustunkok.github.io/tutorial/notes-to-myself/vps/2020/05/16/how-to-create-a-gpu-powered-containerized-multi-user-jupyterhub-research-server.html>How to Create a GPU-Powered Containerized Multi-User JupyterHub Research Server? | Tolga Üstünkök’s Personal Web Site</a></li><li><a href=https://github.com/jupyter/docker-stacks>https://github.com/jupyter/docker-stacks</a></li><li><a href=https://github.com/iot-salzburg/gpu-jupyter>https://github.com/iot-salzburg/gpu-jupyter</a></li></ul></div><div class=post-footer></div></article></main></body></html>